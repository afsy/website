{% extends 'Avent/day.html.twig' %}

{% set year = 2017 %}

{% block article_title "Jour 17 - Bien d√©marrer avec Symfony et React" %}

{% block article_content %}
    {% verbatim %}

    <style type="text/css">
        em {
            font-family: sans-serif;
        }
    </style>

    <h1 id="bien-demarrer-avec-symfony-et-react">Bien d√©marrer avec Symfony et React</h1>

    <p>Il existe quelques ressources montrant comment associer Symfony et React dans un projet, et je souhaite aller plus en d√©tails sur le d√©marrage d&#39;un projet de ce style ainsi que les diff√©rentes complications qu&#39;il est possible de rencontrer.</p>

    <p>Je vous invite √† aller lire comme premi√®re partie l&#39;article &quot;<a href='https://jolicode.com/blog/marier-react-et-symfony'>Marier React et Symfony</a>&quot; qui vous donnera une bonne introduction √† React et des premi√®res r√©ponses concernant l&#39;internationalisation, la communication entre Twig et React ainsi que la mise en place du rendu serveur.</p>

    <p>Vous trouverez  dans la suite des recommendations et bonnes pratiques qui viennent compl√©ter l&#39;article pour une bonne int√©gration de React dans votre projet Symfony.</p>

    <h2 id="webpack-encore">Webpack Encore</h2>

    <p>Une bonne pratique de d√©veloppement front est d&#39;utiliser un module bundler pour regrouper ses assets ainsi que rajouter des transformations √† notre code. La communaut√© React s&#39;est orient√©e principalement vers <a href='https://webpack.js.org/'>Webpack</a> et c&#39;est aussi le cas de Symfony.</p>

    <p>La configuration de ce dernier peut s&#39;av√©rer un peu verbeuse et obscure, il est donc possible d&#39;utiliser <a href='https://symfony.com/doc/current/frontend.html'>Webpack Encore</a> qui est une l√©g√®re couche d&#39;abstraction avec de la configuration pr√©d√©finie qui s&#39;associe parfaitement avec la configuration du framework.</p>

    <p>Les principes de Encore sont les m√™mes que pour Webpack : des points d&#39;entr√©es, un dossier de destinations, des loaders... Si vous connaissez d√©j√† l&#39;outil vous ne serez pas perdu.</p>

    <p>Pour notre application il est n√©cessaire d&#39;activer les presets React comme expliqu√© ici <a href='https://symfony.com/doc/current/frontend/encore/reactjs.html' target='_blank' >https://symfony.com/doc/current/frontend/encore/reactjs.html</a></p>

    <h2 id="transformation-du-javascript">Transformation du JavaScript</h2>

    <p>Gr√¢ce √† Webpack Encore et sa configuration par d√©faut, nous pouvons utiliser la syntaxe <a href="https://babeljs.io/learn-es2015/">ES6</a> qui est le standard actuel de JavaScript. De plus en activant le preset React nous d√©bloquons aussi la syntaxe JSX utilis√©e par les composants..</p>

    <p>Le site web <a href='http://babeljs.io/' target='_blank' >babeljs.io</a> est tr√®s pratique pour se familiariser avec cette syntaxe, il est aussi possible d&#39;utiliser le <abbr title="Read‚Äìeval‚Äìprint loop" lang="en">REPL</abbr> et d&#39;exp√©rimenter avec le code g√©n√©r√©.</p>

    <pre><code class="php language-js">// Avant
const helloWorldJsx = (
  &lt;div&gt;
    &lt;p&gt;Hello there !&lt;/p&gt;
  &lt;/div&gt;
);

// Apr√®s
var helloWorldJsx = React.createElement(
  &quot;div&quot;,
  null,
  React.createElement(
    &quot;p&quot;,
    null,
    &quot;Hello there !&quot;
  )
);</code></pre>

    <h2 id="architecture">Architecture</h2>

    <p>Il y a plusieurs approches selon si vous rajoutez React sur de l&#39;existant ou sur un projet de z√©ro.
    En effet si c&#39;est dans une optique de migration il va √™tre plus int√©ressant de d√©marrer par quelques composants simples tel qu&#39;un autocomplete ou un datepicker avant de refactoriser une interface de recherche compl√®te.</p>

    <h3 id="plusieurs-approches">Plusieurs approches</h3>

    <p><strong>Am√©lioration ou migration de l&#39;existant</strong>: √† privil√©gier lors de l&#39;int√©gration de React sur de l&#39;existant ou quand vous souhaitez garder le maximum d&#39;interface dans Twig. D√©marrez par quelques √©l√©ments de l&#39;interface non critique pour se familiariser avec le paradigme des composants et de la communication entre ces derniers. Il est pr√©f√©rable d&#39;aborder une nouvelle technologie par it√©ration plut√¥t que refactoriser tout le front et se retrouver coinc√© dans de mauvaises impl√©mentations.</p>

    <p><strong>Application JavasScript</strong>: Cette approche est √† envisager lorsque vous partez de z√©ro et souhaitez avoir une application compl√®tement JavaScript. Ainsi Symfony sera principalement utilis√© comme serveur d&#39;API. Sur ce type d&#39;application il y aura des concepts beaucoup plus avanc√©s tels que le routing c√¥t√© client, l&#39;authentification ou encore le rendu serveur avec Node.js.</p>

    <h3 id="communication-entre-symfony-et-react">Communication entre Symfony et React</h3>

    <h4 id="php-vers-js">PHP vers JS</h4>

    <p>Vous allez surement avoir besoin de passer des donn√©es venant de votre contr√¥leur √† votre composant. L&#39;approche la plus simple √©tant d&#39;utiliser Twig comme passerelle pour vos donn√©es.
    Soit en utilisant les data-attributes</p>

    <pre><code class='language-twig' lang='twig'>{# layout.html.twig #}
{% block body %}
  &lt;div id=&quot;list&quot; data-items=&quot;{{ items|json_encode }}&quot;&gt;&lt;/div&gt;
{% endblock %}</code></pre>

    <p>ou en utilisant des helpers d&#39;initialisation de vos composants, expos√©s globalement</p>

    <pre><code class='language-twig' lang='twig'>{% block JavaScripts %}
&lt;script type=&quot;text/javascript&quot;&gt;
  MyApp.initListComponent(&#39;todolist&#39;, {{(items|json_encode|raw)}})
&lt;/script&gt;
{% endblock %}</code></pre>

    <p>J&#39;ai tendance √† pr√©f√©rer la deuxi√®me approche qui me permet de savoir quel composant est utilis√© directement dans ce template Twig, cel√† √©vite aussi de polluer le DOM et √©conomise un querySelector en plus pour r√©cup√©rer les donn√©es.</p>

    <p>Il est bien sur aussi possible de r√©cup√©rer des donn√©es en ex√©cutant une requ√™te Ajax √† Symfony. Par exemple sur un site avec un proxy de cache HTML, il est impossible d&#39;avoir des informations sp√©cifique √† l&#39;utilisateur dans le html g√©n√©r√© par Twig. Une requ√™te Ajax pour r√©cup√©rer les informations de l&#39;utilisateur est donc envoy√© au chargement de la page puis le r√©sultat mis en cache dans le local storage. Nous verrons plus tard que ce m√©canisme est facile √† impl√©menter via Redux.</p>

    <h4 id="js-vers-php">JS vers PHP</h4>

    <p>Cela marche dans l&#39;autre sens, pour envoyer vos donn√©es √† l&#39;applicatif PHP une simple requ√™te HTTP suffit.</p>

    <pre><code class='language-javascript' lang='javascript'>fetch(&#39;https://api.github.com/gists&#39;, {
    method: &#39;post&#39;,
    body: JSON.stringify(opts),
    // Inclure les cookies dans la requ√™te
    credentials: &#39;include&#39;,
    // Pour que vos contr√¥leurs Symfony consid√®rent la requ√™te comme une requ√™te Ajax
    headers: {&#39;X-Requested-With&#39;: &#39;XMLHttpRequest&#39;}
}).then(response =&gt; response.json())</code></pre>

    <h3 id="bonnes-pratiques-react">Bonnes pratiques React</h3>

    <p>Vous trouverez de nombreux articles concernant les bonnes pratiques, en voici une liste non exhaustive</p>

    <p><a href='https://www.robinwieruch.de/tips-to-learn-react-redux/' target='_blank' >https://www.robinwieruch.de/tips-to-learn-react-redux/</a> (en particulier la partie &quot;On-boarding&quot; si votre √©quipe d√©marre)</p>

    <p><a href='https://engineering.musefind.com/our-best-practices-for-writing-react-components-dec3eb5c3fc8' target='_blank' >https://engineering.musefind.com/our-best-practices-for-writing-react-components-dec3eb5c3fc8</a></p>

    <h4 id="architecture-front-avec-redux">Architecture front avec Redux</h4>

    <p>C&#39;est l&#39;architecture autour de React la plus populaire. Elle permet de centraliser les donn√©es tout en permettant un partage facile de celles-ci dans vos composants. On pourrait r√©sumer simplement via cette formule :</p>

    <pre><code class='language-javascript' lang='javascript'>(previousState, action) =&gt; newState</code></pre>

    <p>Notre application va donc contenir un √©tat (&quot;state&quot;, √† ne pas confondre avec le state de vos composants) qui va √©voluer via le traitement d&#39;action. Les actions peuvent √™tre des actions utilisateurs tels que le clique sur un lien mais aussi des effets de bords comme par exemple l&#39;arriv√©e d&#39;une r√©ponse √† traiter.</p>

    <p>Les termes √† comprendre sont &quot;reducers&quot;, &quot;action&quot;, &quot;store&quot; et &quot;connect&quot;. Nous n&#39;allons pas d√©tailler Redux ici, <a href='https://redux.js.org/'>la documentation officielle</a> est d√©j√† une tr√®s bonne r√©f√©rence.</p>

    <p>Un cas pratique dans Symfony est quand  vous disposez de plusieurs points de montages diff√©rents, par exemple un composant dans le header et un autre dans le footer, leur injecter le store Redux permet de communiquer facilement entre eux en partageant le m√™me √©tat.</p>

    <p>Des middlewares peuvent apporter des fonctionnalit√©s suppl√©mentaires de mani√®re tr√®s simple, comme par exemple <a href='https://github.com/rt2zz/redux-persist'>redux-persist</a> qui permet d&#39;ajouter la persistance du state dans le local storage automatiquement.</p>

    <h4 id="higher-order components">Higher-Order components</h4>

    <p>Vous entendrez souvent ces termes lorsqu&#39;on parle de composants containers. Dans Symfony nous avons l&#39;habitude de rajouter des fonctionnalit√©s via l&#39;extension de classe PHP, dans React c&#39;est la composition qui est privil√©gi√©e et on va ainsi parler de Higher-Order components (HOC). Le principe est de cr√©er une fonction qui prend en param√®tre un composant et va retourner un autre composant avec les nouvelles fonctionnalit√©s. Ce pattern est devenu tellement commun qu&#39;il est maintenant <a href='https://reactjs.org/docs/higher-order-components.html'>inclu dans la documentation officielle</a>.</p>

    <p>Il existe d&#39;autres patterns et surtout des anti-patterns dans lesquels il est facile de tomber lors que l&#39;on d√©marre ! N&#39;h√©sitez pas √† aller faire un tour sur le d√©p√¥t <a href='https://github.com/vasanthk/react-bits'>react-bits</a> qui en liste quelques un, m√™me en ayant utilis√© React depuis sa sortie on y trouve de nouvelles id√©es. </p>

    <h4 id="trouver-les-bons-composants">Trouver les bons composants</h4>

    <p>Dans l&#39;√©cosyst√®me Symfony nous sommes habitu√©s √† chercher les bons outils via Packagist ou Github. Il en est de m√™me pour JavaScript avec NPM qui va vous donner une liste class√© par pertinence avec des statistiques sur les  t√©l√©chargements et la maintenance du projet. Exemple pour chercher un composant de s√©lection de date : <a href='https://www.npmjs.com/search?q=react%20datepicker&page=1&ranking=optimal' target='_blank' >https://www.npmjs.com/search?q=react%20datepicker&page=1&ranking=optimal</a></p>

    <p>Il existe aussi des sites pr√©-s√©lectionnant des composants de qualit√© comme le site JS.coach : <a href='https://js.coach/?search=react+datepicker&collection=React'>https://js.coach/?search=react+datepicker&amp;collection=React</a></p>

    <h4 id="rendu-cote-serveur">Rendu c√¥t√© serveur</h4>

    <p>L&#39;int√©r√™t du rendu serveur est de r√©duire le temps d&#39;affichage de votre page en effectuant le rendu du HTML c√¥t√© serveur. C&#39;est ce qui est fait dans vos templates PHP naturellement et qui va √™tre plus complexe √† mettre en place avec vos composants React.</p>

    <p>En effet l&#39;environnement n&#39;est pas le m√™me, comme expliqu√© dans l&#39;article de l&#39;introduction, il est possible d&#39;utiliser React avec le bundle <a href='https://github.com/Limenius/ReactBundle'>LimeniusReactBundle</a> dans Symfony. Il va vous apporter 2 mani√®res de rendre vos composants, soit via <a href='https://github.com/phpv8/v8js'>V8js</a> ou NodeJS.</p>

    <p>Ce bundle va vous exposer des fonctions pour rendre un composant avec ses props dans vos templates Twig. Attention cependant cette architecture reste complexe (V8JS dans Php ou communication socket sur un process node) et les erreurs rencontr√©es peuvent √™tre obscure.</p>

    <p>Celle que vous risquez de rencontrer le plus souvent est le l√©gendaire &quot;window is not defined&quot;, en effet votre JavaScript n&#39;est pas ex√©cut√© dans le navigateur et cet objet global n&#39;existe pas, il faudra donc ruser si vous souhaitez importer du code qui n√©cessite cet objet. Si c&#39;est simplement un import il suffira de d√©tecter si l&#39;objet window est d√©fini, sinon nous poss√©dons la fonction <code>componentDidMount</code>dans un composant React.</p>

    <pre><code class='language-javascript' lang='javascript'>// V√©rification simple avant l&#39;import d&#39;un module qui n√©cessite l&#39;objet window
if (typeof window !== `undefined`) {
  const module = require(&quot;module&quot;);
}

// Utilisation des fonctions lifecycles de React, componentDidMount n&#39;est appel√© que sur le client
export default class MyClass extends React.Component {
    ...
    componentDidMount() {
        const MyWindowDependentLibrary = require( &#39;path/to/library&#39; );
        MyWindowDependentLibrary.doWork();
    }
    ...
}</code></pre>

    <p>Le bundle cit√© plus haut se base sur <a href="https://github.com/shakacode/react_on_rails">React on Rails</a> qui est une int√©gration de React avec le framework Ruby on Rails. Il existe aussi une autre alternative un peu plus r√©cente et moins coupl√© √† l&#39;√©cosyst√®me Ruby appel√© <a href='https://github.com/airbnb/hypernova'>Hypernova</a>.</p>

    <h4 id="une-application-js-independante-avec-rendu-server">Une application JS ind√©pendante avec rendu serveur</h4>

    <p>Si votre choix s&#39;est pos√© sur une application Symfony comme API et une application React d√©coupl√©e, vos composants vont r√©cup√©rer leur donn√©es via des requ√™tes HTTP au lieu d&#39;avoir des donn√©es pass√©es via Twig.</p>

    <p>J&#39;appr√©cie plus particuli√®rement cette approche car il est plus facile de faire √©voluer ind√©pendamment le front et le back. Cependant il faudra se pencher sur le rendu serveur ainsi que le routing d&#39;une application NodeJS. Vous trouverez beaucoup, si ce n&#39;est trop d&#39;articles pour impl√©menter ceci. Avoir une int√©gration plus compl√®te en mode single page app va vous permettre d&#39;avoir des optimisations tels que du <a href='https://github.com/ReactTraining/react-router/blob/master/packages/react-router-dom/docs/guides/code-splitting.md'>code splitting par rapport au routeur</a>.</p>

    <p>Il y a aussi de belles initiatives pour simplifier cette t√¢che comme le framework <a href='https://github.com/zeit/next.js/'>next.js</a>.</p>

    <h3 id="tester-vos-composants">Tester vos composants</h3>

    <p>Nous avons l&#39;habitude d&#39;effectuer des tests fonctionnels dans nos applications Symfony, pour v√©rifier nos r√©ponses ainsi que la pr√©sence de certains √©l√©ments dans la page. Avec React et son approche composant nous pouvons avoir une approche plus unitaire pour le front.</p>

    <p>Je recommande fortemment d&#39;utiliser <a href='https://facebook.github.io/jest/docs/en/tutorial-react.html#'>Jest</a> (aussi d√©velopp√© par Facebook) qui va nous apporter une API pour manipuler les props de nos composants ainsi qu&#39;une fonctionnalit√© de snapshot pour comparer des rendus.</p>

    <blockquote><p>Exemple d&#39;un composant test√© avec Jest</p>
    </blockquote>

    <pre><code class='language-javascript' lang='javascript'>// Link.test.js
import React from &#39;react&#39;;
import renderer from &#39;react-test-renderer&#39;;

import Link from &#39;../Link&#39;;

test(&#39;Link changes the class when hovered&#39;, () =&gt; {
  const component = renderer.create(
    &lt;Link page=&quot;http://www.facebook.com&quot;&gt;Facebook&lt;/Link&gt;,
  );
  let tree = component.toJSON();
  expect(tree).toMatchSnapshot();

  // manually trigger the callback
  tree.props.onMouseEnter();
  // re-rendering
  tree = component.toJSON();
  expect(tree).toMatchSnapshot();

  // manually trigger the callback
  tree.props.onMouseLeave();
  // re-rendering
  tree = component.toJSON();
  expect(tree).toMatchSnapshot();
}); </code></pre>

    <p>On peut aller beaucoup plus loin en rajoutant des tests de l&#39;architecture Redux, encore une fois cette partie est elle aussi parfaitement expliqu√©e dans <a href='https://redux.js.org/docs/recipes/WritingTests.html'>la documentation officielle</a>.</p>

    <p>De la m√™me mani√®re qu&#39;avec Symfony et les services par exemples, si votre code devient difficile √† tester c&#39;est qu&#39;il est trop coupl√© et poss√®de trop de responsabilit√©. Par exemple un composant responsable √† la fois de r√©cup√©rer des donn√©es sur une API, rendre du contenu et le rendre triable va √™tre tr√®s difficile √† tester et r√©utiliser, il faut donc le d√©couper en 3 diff√©rents composants.</p>

    <h3 id="conclusion">Conclusion</h3>

    <p>Suivre ces pratiques vous aidera √† r√©aliser un projet de qualit√© avec du code r√©utilisable, test√© et d√©coupl√©. Il existe de nombreux starters kit avec React mais qui sont vraiment centr√© sur l&#39;√©cosyst√®me JavaScript. L'&#39;exemple open source le plus avanc√© avec Symfony est celui de LimeniusReactbundle avec cette <a href='https://github.com/Limenius/symfony-react-sandbox'>sandbox</a> dans laquelle vous allez pouvoir trouver une impl√©mentation avec Redux. Il existe aussi d&#39;autres int√©grations React int√©ressante tels que le <a href='https://api-platform.com/docs/client-generator/react'>client generator d&#39;API-platform</a> pour cr√©er rapidement un projet React avec une API.</p>

    <p>√Ä vos composants ! ‚öõÔ∏è ‚öõÔ∏èÔ∏è</p>

{% endverbatim %}
{% endblock %}

{% block article_avatar %}
    <img src="{{ asset('build/images/avent/thibault-lenclos.jpg') }}" alt="Thibault Lenclos"/>
{% endblock %}

{% block article_bio %}
    <h2><a href="{% block author_url 'https://twitter.com/ThibZ' %}" target="_blank">{% block article_author 'Thibault Lenclos' %}</a></h2>
    <p>
        D√©veloppeur web et mobile chez Jolicode, Symfony üíõ React+native.
    </p>
{% endblock %}
