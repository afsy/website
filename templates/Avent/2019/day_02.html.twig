{% extends 'Avent/day.html.twig' %}

{% set year = 2019 %}

{% block article_title "Jour 02 - L'√©pop√©e d'une migration de Symfony 4.3 √† Symfony 5.0 " %}

{% block article_content_md %}
Nous aimerions d√©buter ce calendrier de l'avent avec un retour d'exp√©rience sur notre migration vers Symfony 5. Nous avons fait √©voluer notre side-project [Secret-Santa.team](https://secret-santa.team) de Symfony 4.3 √† 4.4, puis 5.0, et nous voulons vous montrer quelles ont √©t√© nos difficult√©s et les changements que nous avons d√ª apporter, afin de vous √©clairer sur la facilit√© (ou non) d'entreprendre une telle mise √† jour.

Le projet est open-source, il est plut√¥t simple mais fait appel √† des bundles tiers, des API... Son r√¥le est de se connecter √† vos teams Slack ou Discord et vous permettre d'effectuer des tirages Secret Santa ! #teamBuilding

![Secret-Santa]({{ asset('build/images/avent/2019/02/secret-santa.gif') }} "Site Web Secret Santa")

## Commen√ßons par la 4.4

Avant de passer en version 5, nous allons d'abord passer notre application en Symfony 4.4.
En effet, Symfony respecte la convention [SemVer](https://semver.org/), c'est-√†-dire qu'il est possible de monter la version mineure du framework sans avoir de changement √† apporter √† notre code. Symfony ne s'emp√™che √©videmment pas de faire √©voluer ses fonctionnalit√©s lors de ces releases mineures, mais l'√©quipe fait toujours l'effort de fournir une couche de r√©tro-compatibilit√© pour nous √©viter tout BC-break. Au final, une version majeure (la 5.0 par exemple) est √©quivalente √† la version mineure pr√©c√©dente (4.4) mais sans toutes les couches de r√©tro-compatibilit√©s.

Comme nous le verrons dans la suite, il est important de passer sur la derni√®re version mineure 4.x avant de passer en 5. Si nous passons directement de 4.3 en 5.0, nous risquons de rater certaines d√©pr√©ciations de la 4.4. Pour obtenir la derni√®re release mineure de la version 4, il nous suffit de lancer `composer update` (avec une d√©pendance comme `"symfony/framework-bundle": "^4.3"`).

### Twig 2 ou Twig 3 ?

Avec Symfony >= 4.4, vous pouvez avoir Twig 2.10 ou 3.0 (qui vient de sortir). Nous sommes pass√©s directement √† Twig 3 pour voir, car nous aimons le danger !

Les nouveaut√©s sont :

- PHP 7.2 minimum ;
- les classes "√† la PEAR/PSR-0" sont supprim√©es (`Twig_Environment` devient `Twig\Environment`) ;
- suppression de tout ce qui √©tait d√©pr√©ci√©.

Rien d'insurmontable a priori. Sauf peut-√™tre si vous avez des bundles tiers...

### Bundle tiers et d√©pendances

Nous utilisons `nelmio/security-bundle` - et lui n'est pas compatible Twig 3 √† ce moment-l√†. Nous le voyons tr√®s vite :

> Attempted to load class "Twig_Extension" from the global namespace.
> Did you forget a "use" statement?
> in vendor/nelmio/security-bundle/Twig/NelmioCSPTwigExtension.php (line 19)

C'est l√† que d√©bute le travail d'investigation et de recherche. Pouvons-nous corriger le bundle pour qu'il soit compatible ? Certainement, mais le Bundle se doit d'√™tre compatible avec plusieurs versions de Symfony, et y forcer Twig 3 rendrait le Bundle impossible √† installer sur de nombreux projets !

Nous allons devoir repasser en Twig 2, en plus de rendre le bundle compatible avec Symfony 5. Mais avant √ßa, nous allons mettre √† jour notre propre code.

## Supprimer les usages de code d√©pr√©ci√©

En plus de respecter SemVer, l'√©cosyst√®me Symfony va encore plus loin en mettant en place, au fur et √† mesure des versions mineures, tout un tas de notices de d√©pr√©ciations qui nous indiquent clairement les fonctionnalit√©s que nous utilisons et qui seront supprim√©es dans la prochaine version majeure du framework.

### Surveiller les "deprecation logs"

Une fois que notre projet fonctionne en 4.4, nous devons donc porter une attention particuli√®re √† ces logs de d√©pr√©ciation, √† la fois en surfant sur le projet mais aussi en faisant tourner les tests.

Le premier log que nous voyons alors est :

> The "**twig.exception_controller**" configuration key has been deprecated in Symfony 4.4, set it to "**null**" and use "**framework.error_controller**" configuration key instead.

Il est surprenant car nous n'avons pas cette configuration dans notre projet. En recherchant la source du warning, nous trouvons cela dans le code de Symfony :

```php
->scalarNode('exception_controller')
->defaultValue(static function () {
    @trigger_error('The "twig.exception_controller" configuration key has been deprecated in Symfony 4.4, set it to "null" and use "framework.error_controller" configuration key instead.', E_USER_DEPRECATED);

    return 'twig.controller.exception::showAction';
})
```

C'est la valeur par d√©faut qui provoque un log. Pour ne plus avoir le log, il faut donc suivre √† la lettre le message de d√©pr√©ciation, et mettre une valeur de configuration !

```yaml
twig:
    exception_controller: null # This is needed to fix the deprecation in Symfony 4.4
```

Cependant, un test sur `/_errors/404` provoque maintenant une erreur, nous avons sans doute rat√© quelque chose !

> "**Unable to find the controller for path** "/_errors/404"**. The route is wrongly configured.**"

Oops, seul notre nouvelle valeur (`null`) est utilis√©e, pas la nouvelle option du FrameworkBundle.

L'indice se trouve dans le routing, c'est la route `_twig_error_test` qui a √©t√© match√©e, alors que cette feature fait partie du FrameworkBundle maintenant. Notre `config/routes/dev/twig.yaml` contient en effet :

```yaml
_errors:
    resource: '@TwigBundle/Resources/config/routing/errors.xml'
    prefix:   /_errors
```

Il faut le changer en :

```yaml
_errors:
    resource: '@FrameworkBundle/Resources/config/routing/errors.xml'
    prefix:   /_errors
```

Et cette fois, nos pages d'erreur fonctionnent.

Un autre log, visible dans nos tests cette fois :

> The "Symfony\Component\HttpKernel\Event\GetResponseForExceptionEvent::getException()" method is deprecated since Symfony 4.4, use "getThrowable()" instead.

En ouvrant la classe `GetResponseForExceptionEvent`, nous voyons m√™me le PHPDoc suivant :

> @deprecated since Symfony 4.3, use ExceptionEvent instead

Nous effectuons donc ces changements dans notre `HandleExceptionSubscriber`. Il ne s'agit que du remplacement d'une classe :

```diff
use Psr\Log\LoggerInterface;
use Symfony\Component\EventDispatcher\EventSubscriberInterface;
use Symfony\Component\HttpFoundation\Response;
-use Symfony\Component\HttpKernel\Event\GetResponseForExceptionEvent;
+use Symfony\Component\HttpKernel\Event\ExceptionEvent;
use Symfony\Component\HttpKernel\KernelEvents;
+use Twig\Environment;

...

-    public function __construct(LoggerInterface $logger, \Twig_Environment $twig, Client $bugsnag)
+    public function __construct(LoggerInterface $logger, Environment $twig, Client $bugsnag)

...

-    public function handleException(GetResponseForExceptionEvent $event)
+    public function handleException(ExceptionEvent $event)

...

-        $exception = $event->getException();
+        $exception = $event->getThrowable();
```

Mais le log persiste dans notre rapport PHPUnit... D'o√π peut-il provenir ?!

### Configurer PHPUnit pour voir la stack trace du log

Symfony fournit un [bridge PHPUnit](https://github.com/symfony/phpunit-bridge) qui est tr√®s utile. C'est lui qui nous affiche ce r√©capitulatif sur les d√©pr√©ciations √† la fin des tests :

```
Testing Slack Secret Santa Test Suite
............................                                      28 / 28 (100%)

Time: 441 ms, Memory: 24.00MB

OK (28 tests, 95 assertions)

Remaining indirect deprecation notices (2)

2x: The "Symfony\Component\HttpKernel\Event\GetResponseForExceptionEvent::getException()" method is deprecated since Symfony 4.4, use "getThrowable()" instead.
1x in SantaControllerTest::test_finish_page_returns_404_without_hash from JoliCode\SecretSanta\Tests\Controller
1x in SantaControllerTest::test_finish_page_works_with_invalid_hash from JoliCode\SecretSanta\Tests\Controller
```

Les "deprecation notices" sont **indirect**, c'est-√†-dire qu'elles viennent de code dans **nos vendor**.

Pour corriger cette d√©pr√©ciation, nous avons besoin d'en conna√Ætre l'origine pr√©cise, mais le rapport est agr√©g√©, et ne nous en dit pas plus. Nous pouvons utiliser une option pour forcer l'affichage d'une stack trace compl√®te ! Il suffit de lui donner une expression r√©guli√®re qui matche notre log :

```shell
SYMFONY_DEPRECATIONS_HELPER='/getException/' ./bin/phpunit
```

Le r√©sultat est :

```
Testing Slack Secret Santa Test Suite
.........
Remaining indirect deprecation triggered by JoliCode\SecretSanta\Tests\Controller\SantaControllerTest::test_finish_page_returns_404_without_hash:
The "Symfony\Component\HttpKernel\Event\GetResponseForExceptionEvent::getException()" method is deprecated since Symfony 4.4, use "getThrowable()" instead.
Stack trace:
#0 [internal function]: Symfony\Bridge\PhpUnit\DeprecationErrorHandler->handleError(16384, 'The "Symfony\\Co...', '/home/dalexandr...', 57, Array)
#1 vendor/symfony/http-kernel/Event/GetResponseForExceptionEvent.php(57): trigger_error('The "Symfony\\Co...', 16384)
#2 vendor/bugsnag/bugsnag-symfony/EventListener/BugsnagListener.php(83): Symfony\Component\HttpKernel\Event\GetResponseForExceptionEvent->getException()
```

En remontant la trace, nous voyons que le probl√®me est dans `BugsnagListener.php` ! Une mise √† jour du bundle Bugsnag va donc s'imposer !

Cependant, malgr√© les quelques deprecated indirects qu'il nous reste, tous les tests passent. Nous devons juste faire en sorte que la CI soit contente. Or, en l'√©tat, PHPUnit finit en erreur (code de sortie √† 1) √† cause des d√©pr√©ciations. Heureusement, le bridge de Symfony supporte une option permettant d'√©viter un fail lorsque des deprecated se trouvent dans nos vendors, l'option se nomme `weak_vendors`:

```bash
SYMFONY_DEPRECATIONS_HELPER=weak_vendors bin/phpunit
```

Cela fonctionne parfaitement, √† ceci pr√®s que l'option `weak_vendors` est d√©pr√©ci√©e üò≠ :

```bash
Remaining direct deprecation notices (1)

1x: Setting SYMFONY_DEPRECATIONS_HELPER to "weak_vendors" is deprecated in favor of "max[self]=0"
```

Une deprecated dans la gestion des deprecated ü§î ?

Heureusement, le changement √† appliquer est assez explicite (et [la documentation](https://symfony.com/doc/master/components/phpunit_bridge.html#internal-deprecations) aussi). On ajoute cette variable d'environnement dans notre Makefile pour que cette nouvelle option soit utilis√©e lors du build sur TravisCI et tout est pr√™t.

Tout est vert sur la CI. Quelques tests manuels nous confirment que tout est ok : nous pouvons mettre en prod ! Maintenant que notre application fonctionne parfaitement en Symfony 4.4, pouvons nous passer √† Symfony 5 sans encombres ?

## Migration vers Symfony 5

Malheureusement, non. √Ä chaque nouvelle version majeure de Symfony, l'une des √©tapes les plus fastidieuses est de **faire √©voluer tout l'√©cosyst√®me** pour le rendre compatible avec cette nouvelle version. Et notre application ne fait pas exception : plusieurs de nos d√©pendances ne sont pas encore compatibles. Si vous faites partie des premiers √† entreprendre cette migration, √ßa ne va pas √™tre simple‚Ä¶ Mais il faut bien que quelqu'un le fasse üíõ. C'est ce que nous allons voir tout de suite.

### BugsnagBundle

[Bugsnag](https://www.bugsnag.com/) est un outil permettant de monitorer les erreurs qui surviennent dans vos applications en fournissant un dashboard qui permet, de visualiser les erreurs bien s√ªr, mais aussi le contexte dans lequel elles sont apparues (comme par exemple le contenu de la requ√™te ou de la session), la stack trace, etc.

Pour ce faire, ils fournissent un [bundle Symfony](https://github.com/bugsnag/bugsnag-symfony) qui va se brancher sur les diff√©rents √©v√©nements √©mis par le Kernel, pour ensuite faire remonter les erreurs sur leur dashboard. Malheureusement, ce bundle n'est compatible que jusqu'√† Symfony <= 4.4.

Nous avons donc [cr√©√© une pull request](https://github.com/bugsnag/bugsnag-symfony/pull/92) ajoutant le support de la version 5. Le bundle ne proposant pas √©norm√©ment de fonctionnalit√©s, il n'y a donc pas grand chose √† modifier.

Une fois le projet clon√© en local, la premi√®re chose √† faire est d'autoriser l'installation de la derni√®re version :

```diff
-        "symfony/config": "^2.7|^3.0|^4.0",
-        "symfony/http-kernel": "^2.7|^3.0|^4.0",
-        "symfony/dependency-injection": "^2.7|^3.0|^4.0",
-        "symfony/console": "^2.7|^3.0|^4.0",
-        "symfony/http-foundation": "^2.7|^3.0|^4.0",
-        "symfony/security": "^2.7|^3.0|^4.0",
+        "symfony/config": "^2.7|^3.0|^4.0|^5.0",
+        "symfony/http-kernel": "^2.7|^3.0|^4.0|^5.0",
+        "symfony/dependency-injection": "^2.7|^3.0|^4.0|^5.0",
+        "symfony/console": "^2.7|^3.0|^4.0|^5.0",
+        "symfony/http-foundation": "^2.7|^3.0|^4.0|^5.0",
+        "symfony/security": "^2.7|^3.0|^4.0|^5.0",
```

Apr√®s un `composer update`, nous remarquons que le composant `symfony/security` ne se met pas √† jour en 5.0 : en effet, celui-ci n'existe plus dans cette version. Il faut d√©sormais utiliser ses sous-composants. Dans notre cas, le bundle n'utilise pas beaucoup de fonctionnalit√©s du composant s√©curit√©. Nous pouvons donc simplement require `symfony/security-core` √† la place de `symfony/security`.

En lan√ßant la suite de tests, nous nous rendons compte de plusieurs probl√®mes.

Premi√®rement, certaines classes des √©v√®nements lev√©s par le Kernel ont chang√©. Pour garder la compatibilit√© avec les anciennes versions de Symfony, nous choisissons de supprimer le typage sur les param√®tres re√ßus par les m√©thodes des listeners :

```diff
/**
* Handle an incoming request.
*
-     * @param \Symfony\Component\HttpKernel\Event\GetResponseEvent $event
+     * @param GetResponseEvent|RequestEvent $event
*
* @return void
*/
-    public function onKernelRequest(GetResponseEvent $event)
+    public function onKernelRequest($event)
{
+        // Compatibility with Symfony < 5 and Symfony >=5
+        if (!$event instanceof GetResponseEvent && !$event instanceof RequestEvent) {
+            return;
+        }
+
```

Nous constatons √©galement un autre soucis : l'utilisation du param√®tre `kernel.root_dir`. Celui-ci a √©t√© supprim√© en faveur du nouveau param√®tre `kernel.project_dir`. Ce dernier pointe maintenant √† la racine de l'application (l√† o√π se trouve le fichier `composer.json`), ce qui est plus simple que l'ancien qui pointait l√† o√π √©tait le Kernel (`app/` en Symfony 2 et `src/` en Symfony 3.4+). Pour garder la compatibilit√© avec toutes ces versions de Symfony, nous avons ajout√© un nouveau param√®tre propre au bundle qui sera utilis√© √† la place des param√®tres natifs. Ainsi, ce param√®tre utilisera le `project_dir` s'il est disponible ou utilisera le `root_dir` dans le cas contraire :


```diff
--- a/DependencyInjection/BugsnagExtension.php
+++ b/DependencyInjection/BugsnagExtension.php
@@ -28,5 +28,13 @@ public function load(array $configs, ContainerBuilder $container)
        foreach ($config as $key => $value) {
            $container->setParameter('bugsnag.'.$key, $value);
        }
+
+        if ($container->hasParameter('kernel.project_dir')) {
+            $symfonyRoot = $container->getParameter('kernel.project_dir');
+        } else {
+            $symfonyRoot = $container->getParameter('kernel.root_dir').'/../';
+        }
+
+        $container->setParameter('bugsnag.symfony_root', $symfonyRoot);
    }
}
```

### NelmioSecurityBundle

Nous utilisons aussi [NelmioSecurityBundle](https://github.com/nelmio/NelmioSecurityBundle), pour g√©rer les <abbr title="Content Security Policy">CSP</abbr>, les Referrer Policy et autres features de s√©curit√© que les navigateurs mettent √† disposition des d√©veloppeurs.

Comme pr√©cis√© au d√©but de cet article, ce bundle n'est pas encore compatible avec Symfony 5 et Twig 3. [Nous avons donc entrepris cette mise-√†-jour](https://github.com/nelmio/NelmioSecurityBundle/pull/211).

Comme pour tous les bundles √† mettre √† jour, la difficult√© est de maintenir une compatibilit√© avec les diff√©rentes versions de Symfony. En effet, afin de simplifier la maintenance du bundle, il est int√©ressant d'avoir un m√™me code compatible avec toutes les versions du framework :

- personne n'est laiss√© sur le carreau ;
- la version 3.4 est toujours en LTS ([fin en novembre 2021](https://symfony.com/releases/3.4)) ;
- il n'y a qu'une branche √† maintenir par la communaut√©.

Apr√®s avoir clon√© localement notre fork et lanc√© les tests pour s'assurer que tout fonctionne "avant", nous avons mis √† jour le `composer.json` du projet :

```diff
     ],
     "require": {
         "paragonie/random_compat": "~1.0|~2.0|9.99.99",
-        "symfony/framework-bundle": "~2.3|~3.0|~4.0",
-        "symfony/security": "~2.3|~3.0|~4.0",
+        "symfony/framework-bundle": "~2.3|~v3.0|~4.0|~5.0",
+        "symfony/security-core": "~2.3|~3.0|~4.0|~5.0",
+        "symfony/security-http": "~2.3|~3.0|~4.0|~5.0",
+        "symfony/security-csrf": "~2.3|~3.0|~4.0|~5.0",
         "ua-parser/uap-php": "^3.4.4"
     },
     "require-dev": {
         "doctrine/cache": "^1.0",
         "psr/cache": "^1.0",
-        "twig/twig": "^1.24",
-        "symfony/yaml": "~2.3|~3.0|~4.0",
-        "symfony/phpunit-bridge": "^3.4.24|~4.0"
+        "twig/twig": "^1.24|^2.10",
+        "symfony/yaml": "~2.3|~3.0|~4.0|~5.0",
+        "symfony/phpunit-bridge": "~5.0"
```

D√®s lors, il est question de corriger tout ce qui ne va plus fonctionner. Nous retrouvons d'ailleurs quelques similarit√©s avec BugsnagBundle, notamment les √©v√©nements qui ont chang√© de noms :

- `GetResponseEvent` remplac√© par `RequestEvent` ;
- `FilterResponseEvent` remplac√© par `ResponseEvent`.

Nous avons donc, l√† aussi, enlev√© les type hint dans les Listener, et rendu les tests compatibles avec les deux classes.

M√™me probl√®me avec le composant `symfony/security`, qui sera ici, remplac√© par 3 de ses sous-composants.

Nous avons profit√© de cette PR pour ajouter le support de Twig 2 qui √©tait jusqu'alors absent du Bundle.

Le bundle utilise, lui aussi, le brige PHPUnit. Et c'est d'une grande aide, car les tests sont lanc√©s sur PHP 5 et PHP 7, avec des versions de Symfony allant de 2 √† 5 ! En plus de √ßa, PHPUnit 8 a maintenant des typages forts sur ces signatures de m√©thodes (donc intrins√®quement incompatible avec PHP 5) :

> PHP Fatal error:  Declaration of Nelmio\SecurityBundle\Tests\EncrypterTest::setUp() must be compatible with PHPUnit\Framework\TestCase::setUp(): void in /NelmioSecurityBundle/Tests/EncrypterTest.php on line 55

Pour palier ce probl√®me, le bridge de Symfony nous offre, entre autre, l'option `SYMFONY_PHPUNIT_REMOVE_RETURN_TYPEHINT`. En mettant cette variable √† 1, les type hints de PHPUnit 8 seront retir√©s √† la vol√©e. Elle nous permet donc de garder des signatures sans type hint, car PHPUnit est rendu compatible, au runtime, par le bridge : malin ! Nous avons donc ajout√© le code suivant directement dans le `phpunit.xml.dist` du Bundle :

```xml
    <php>
        <env name="SYMFONY_PHPUNIT_REMOVE_RETURN_TYPEHINT" value="1"/>
    </php>
```

Dans les versions modernes de PHPUnit, les annotations sont aussi d√©pr√©ci√©es.

> There was 1 warning:
> 1) Nelmio\SecurityBundle\Tests\SignerTest::testConstructorShouldVerifyHashAlgo
The @expectedException, @expectedExceptionCode, @expectedExceptionMessage, and @expectedExceptionMessageRegExp annotations are deprecated. They will be removed in PHPUnit 9. Refactor your test to use expectException(), expectExceptionCode(), expectExceptionMessage(), or expectExceptionMessageRegExp() instead.

Nous les avons donc remplac√©es par ces m√©thodes, mais elles n'existent pas en PHP 5 / Symfony 2 / PHPUnit 5 ! Encore une fois, le bridge nous simplifie le travail en fournissant des polyfills pour ces m√©thodes. Nous pouvons donc mettre √† jour les tests sans craintes.

Le seul probl√®me que nous avons rencontr√© concerne PHP 5.4. En effet, le bridge en version 4.2 est uniquement compatible PHP 5.5+, mais les polyfill ne sont pr√©sents que dans les versions ult√©rieures...

Supporter autant de version de PHP et de Symfony est une t√¢che complexe, et impossible √† r√©aliser sans le bridge PHPUnit ! Alors, merci petit bridge üòª

Apr√®s quelques sueurs, nous avons enfin aper√ßu le paradis :

![Tests verts sur Travis CI]({{ asset('build/images/avent/2019/02/travis-ci.png') }} "Tests verts sur Travis CI")

Voil√† ! Le bundle est d√©sormais compatible avec la derni√®re version de notre framework. Enfin, pas tout √† fait....

### Quelques astuces Composer

Toutes nos d√©pendances sont maintenant compatibles avec Symfony 5.0‚Ä¶ ou presque. En effet, bien que des PRs soient pr√™tes pour les projets dont nous d√©pendons, elles ne sont, pour autant, pas encore merg√©es, et encore moins disponibles dans une release. Il va donc falloir tricher si l'on veut passer √† Symfony 5 rapidement.

La premi√®re solution, si une PR est disponible pour la d√©pendance en question, consiste √† utiliser ce fork √† la place du repository original. Pour ce faire,il suffit de suivre la [doc de Composer](https://getcomposer.org/doc/05-repositories.md#vcs) pour charger un package depuis un repository donn√©:

```diff
     "require": {
-        "bugsnag/bugsnag-symfony": "^1.5",
+        "bugsnag/bugsnag-symfony": "dev-symfony-5",
         "jolicode/slack-php-api": "^2.0",
-        "nelmio/security-bundle": "^2.7",
+        "nelmio/security-bundle": "dev-symfony5-simple",
         ...
     },
+    "repositories": [
+        {
+            "type": "vcs",
+            "url": "https://github.com/pyrech/bugsnag-symfony"
+        },
+        {
+            "type": "vcs",
+            "url": "https://github.com/damienalexandre/NelmioSecurityBundle"
+        }
+    ],
```

Dans le cas o√π la d√©pendance n'est pas du tout compatible et qu'aucune PR en cours n'existe que nous pourrions utiliser, il existe une autre solution. Nous pouvons en effet utiliser le syst√®me d'alias de Composer. Beaucoup plus risqu√©, le but de cette solution est de faire croire √† nos d√©pendances qu'un package est install√© dans une autre version. La [documentation de Composer](https://getcomposer.org/doc/articles/aliases.md#require-inline-alias) nous explique, encore une fois, comment faire :

```diff
-        "symfony/yaml": "^4.4"
+        "symfony/yaml": "5.0.0 as 4.4"
```

Ainsi, ce package sera bien install√© en version 5, m√™me si les autres packages requi√®rent une version 4.x. C'est une solution risqu√©e qui peut √©videmment amener de nombreux probl√®mes. Il est donc n√©cessaire de v√©rifier que tout fonctionne correctement.

C'est ce que nous avons fait pour r√©gler un probl√®me simple de compatibilit√©, o√π `jane-php/json-schema-runtime` demande `symfony/yaml` en version ^4.0.

### Derni√®re ligne droite


La PR finale pour passer de [Symfony 4.4 √† 5.0 est plut√¥t courte](https://github.com/jolicode/secret-santa/pull/133). Il nous restait seulement trois changements √† effectuer dans le code :

```diff
--- a/public/index.php
+++ b/public/index.php

 use JoliCode\SecretSanta\Kernel;
-use Symfony\Component\Debug\Debug;
 use Symfony\Component\Dotenv\Dotenv;
+use Symfony\Component\ErrorHandler\Debug;
 use Symfony\Component\HttpFoundation\Request;


--- a/src/EventListener/RedirectOldDomainSubscriber.php
+++ b/src/EventListener/RedirectOldDomainSubscriber.php

 use Symfony\Component\EventDispatcher\EventSubscriberInterface;
 use Symfony\Component\HttpFoundation\RedirectResponse;
-use Symfony\Component\HttpKernel\Event\GetResponseEvent;
+use Symfony\Component\HttpKernel\Event\RequestEvent;
 use Symfony\Component\HttpKernel\KernelEvents;

 class RedirectOldDomainSubscriber implements EventSubscriberInterface
 {
-    public function redirectOldDomain(GetResponseEvent $event)
+    public function redirectOldDomain(RequestEvent $event)


--- a/tests/Controller/SessionPrepareTrait.php
+++ b/tests/Controller/SessionPrepareTrait.php

 namespace JoliCode\SecretSanta\tests\Controller;

-use Symfony\Bundle\FrameworkBundle\Client;
+use Symfony\Bundle\FrameworkBundle\KernelBrowser;

 trait SessionPrepareTrait
 {
-    public function prepareSession(Client $client, string $key, $value)
+    public function prepareSession(KernelBrowser $client, string $key, $value)
     {
```

Ces changements sont li√©s √† des composants renomm√©s ou des classes retir√©es du framework. Nous ne les avons pas vus lors de la migration en 4.4 pour 2 raisons. Concernant le listener, il n'√©tait tout simplement pas ex√©cut√© : son r√¥le est de rediriger l'ancien nom de domaine. Il n'est donc jamais utilis√© en local.

Pour les 2 autres modifications, elles sont dues √† du code d√©pr√©ci√© en version 4 mais qui ne d√©clenchait pas de log de d√©pr√©ciations. √áa arrive ! ü§∑

That's it! Nous sommes maintenant compatible avec Symfony 5.0 ! üéâ

Il est √† noter que nous aurions aussi pu utiliser la commande `composer symfony:sync --force` pour mettre √† jour certains fichiers automatiquement √† partir des derni√®res versions [des recipes](https://github.com/symfony/recipes).

## Migration termin√©e

M√™me si notre application n'a pas autant de fonctionnalit√©s qu'un gros projet client, nous remarquons que la migration vers une nouvelle version majeure de Symfony ne se fait pas sans mal.

Dans notre cas, le code ne n√©cessite pas de grosses modifications car la plupart des fonctionnalit√©s de Symfony restent identiques. Pour celles qui changent, l'√©quipe de Symfony fait un excellent travail avec les logs de d√©pr√©ciations. Ce syst√®me nous facilite √©norm√©ment la mont√©e de version.

En revanche le plus contraignant est d'attendre que toutes nos d√©pendances (g√©n√©ralement les bundles) sortent une nouvelle release ajoutant la compatibilit√© avec la nouvelle version. Vous pouvez acc√©l√©rer les choses et proposez vous m√™me la PR qui rend compatible tel ou tel Bundle : ils sont nombreux √† attendre votre contribution, n'h√©sitez plus, vous avez maintenant notre exp√©rience comme socle !

Tr√®s bonnes f√™tes √† tous !
{% endblock %}

{% block article_avatar %}
    <img src="{{ asset('build/images/avent/loick-piera.png') }}"
         alt="Lo√Øck Piera"/>
    <img src="{{ asset('build/images/avent/damien-alexandre.png') }}"
         alt="Damien Alexandre"/>
{% endblock %}

{% block article_bio %}
    <h2>
        <a href="https://twitter.com/pyrech"
           target="_blank" rel="noopener noreferrer">Lo√Øck Piera</a>
        et <a href="https://twitter.com/damienalexandre" target="_blank" rel="noopener noreferrer">Damien Alexandre</a>
    </h2>

    <p>
        {% block article_author 'Lo√Øck et Damien' %} sont d√©veloppeurs Web chez <a href="{% block author_url 'https://jolicode.com' %}" target="_blank" rel="noopener noreferrer">JoliCode</a> ; o√π ils mettent leur expertise et leur passion au service de leurs clients.
    </p>
{% endblock %}
