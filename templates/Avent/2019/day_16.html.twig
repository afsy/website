{% extends 'Avent/day.html.twig' %}

{% set year = 2019 %}

{% block article_title "Jour 16 - Retour d'expÃ©rience sur Sylius, le framework e-commerce qui a du style !" %}

{% block article_content_md %}
# Retour d'expÃ©rience sur Sylius, le framework e-commerce qui a du style !

Tout dâ€™abord, il faut savoir que je n'ai pas Ã©tÃ© le plus assidu sur la veille "PHP/e-commerce" ces derniÃ¨res annÃ©es.
Pour moi, il nâ€™y a encore pas si longtemps, Magento Ã©tait LA grande rÃ©fÃ©rence PHP pour lâ€™e-commerce - hors Wordpress et ses plugins.

Il y a environ 5 ans, jâ€™ai Ã©tudiÃ© Sylius pour les besoins dâ€™un client. Ã€ l'Ã©poque, le projet ressemblait surtout Ã  une collection d'interface, avec finalement peu de code, et surtout quasi aucune documentation.

Cependant, depuis maintenant quelques mois, le nom de Sylius ressort de plus en plus dans des articles, des confÃ©rences, ...
Et contrairement aux retours sur Magento qui ne sont pas toujours Ã©logieux, ceux sur Sylius semblent tous aller dans le mÃªme sens : un projet de qualitÃ© qui mÃ©rite de se (re-)pencher dessus.

## Il est long le chemin ! ğŸµ ğŸµ ğŸµ

Sylius se dÃ©crit comme une "plateforme e-commerce Open Source basÃ©e sur Symfony".

Cependant avant de devenir cette plateforme complÃ¨te, il lui aura fallu quelques annÃ©esâ€¦ Ce projet a [dÃ©butÃ© en 2011](https://firstcommit.netlify.com/?repo=Sylius/Sylius) ! Le premier commit du dÃ©pÃ´t `Sylius/Sylius` dÃ©voile un simple bundle de gestion d'adresses. Sâ€™en sont suivi diffÃ©rents bundles e-commerce.

En 2017, la v1 sort avec des bundles revus sous forme de composants sÃ©parÃ©s et un core en guise de glue pour les rÃ©unir.

![Architecture de Sylius]({{ asset('build/avent/2019/16/ecommerce_pic_7.png') }} "Architecture de Sylius")

## Un couteau suisse de l'e-commerce ? ğŸ‡¨ğŸ‡­

Avec lâ€™Ã©dition `sylius-standard`, il est possible de configurer un certain nombres paramÃ¨tres pour notre boutique :
- les [canaux de vente](https://docs.sylius.com/en/1.6/book/configuration/channels.html) possibles ğŸŒ ;
- les devises et langues qui vont pouvoir Ãªtre utilisÃ©es ğŸ‡«ğŸ‡· ;
- les pays dans lesquels nous allons vendre nos articles ğŸ—¾ ;
- les taxes et leurs catÃ©gories Ã  appliquer selon le type de produit ğŸ’¶ ;
- les taux de conversions entre devises ğŸ’± ;
- les moyens de livraison disponibles ğŸšš ;
- les modes de paiement Ã  intÃ©grer dans le tunnel de commande ğŸ¦ ;
- ...

Toutes ces configurations sont extrÃªmement puissantes et pensÃ©es pour pouvoir s'adapter Ã  une grande majoritÃ© d'e-commerce.

Prenons par exemple un moyen de livraison :

![Ã‰dition d'un moyen de livraison]({{ asset('build/avent/2019/16/shipping-method.png') }} "Ã‰dition d'un moyen de livraison")

Nous pouvons modifier :
- ses noms et descriptions selon les langues activÃ©es ;
- sa disponibilitÃ© selon les canaux de vente crÃ©Ã©s ;
- les contraintes de celui-ci - _par exemple : tous les produits de la commandes doivent Ãªtre de type VÃªtement_ ;
- les taxes associÃ©es ;
- le prix par canal de vente et la mÃ©thode de calcul - _prix fixe par commande ou par Ã©lÃ©ment du panier_.

La configuration pourra Ãªtre un peu longue selon la boutique Ã  mettre en place, mais il y a de grandes chances pour qu'il ne soit pas nÃ©cessaire d'Ã©crire du code pour adapter des Ã©lÃ©ments.

Une fois notre boutique configurÃ©e, il nous faut un catalogue produits.
Sylius intÃ¨gre une gestion plutÃ´t exhaustive des produits, composÃ©s d'attributs et d'options, de stock et de prix, tout en intÃ©grant la notion de taxonomie afin de les catÃ©goriser.

De plus, Sylius intÃ¨gre la crÃ©ation des comptes clients, les commentaires des clients sur les produits, la gestion complÃ¨te des codes promotionnels et, Ã©videmment, un tunnel d'achat du panier jusqu'Ã  la commande livrÃ©e.

Tout ceci est disponible via un front en Twig/JS, une interface d'administration et une API REST.

Ã€ noter : il nâ€™y a pas de rÃ©elle partie CMS dans le projet.

## Sous le capot ğŸš—

Sylius se base sur des projets open source qui ont fait leurs preuves : Symfony, Twig, Doctrine, Behat, PHPSpec, â€¦
Cela en fait un projet trÃ¨s simplement comprÃ©hensible par tous dÃ©veloppeurs Symfony.

Utilisant la puissance de Symfony associÃ©e Ã  une bonne architecture de code, il devient extrÃªmement [simple de modifier](https://docs.sylius.com/en/1.6/customization/) les entitÃ©s, les formulaires, les repositories, â€¦
L'utilisation de [winzou/state-machine](https://github.com/winzou/StateMachineBundle) pour tout le tunnel de commande permet de l'adapter Ã  sa guise en seulement quelques heures.
Le projet, codÃ© Ã  l'aide de la mÃ©thode BDD, intÃ¨gre une suite de tests contenant plus de 1200 scÃ©narii.

Le front et l'admin sont basÃ©s sur [semantic-ui](https://semantic-ui.com/) (et, Ã  mon humble avis, le rendu est tellement plus propre quâ€™un EasyAdmin2 !)

## Pour aller plus loin ğŸš€

Sylius intÃ¨gre aussi un systÃ¨me de plugins et, depuis peu, ceux-ci sont disponible via un [Store officiel](https://sylius.com/plugins/). Nous pouvons trouver de quoi enrichir facilement notre boutique, et notamment :
- gÃ©nÃ©rer des factures ;
- ajouter un CMS ;
- ajouter divers systÃ¨mes de paiement ;
- gÃ©nÃ©rer un sitemap ;
- ajouter un systÃ¨me de whishlist ;
- ...

Tout comme pour une librairie ou un bundle Symfony, il est nÃ©cessaire d'Ã©tudier un peu le code du plugin avant de l'utiliser.

Il existe Ã©galement [Sylius Plus](https://sylius.com/plus/), une version payante - le prix dÃ©pend du volume de vente sur le site. Elle permet notamment d'avoir un support dÃ©diÃ© et dÃ©bloque des fonctionnalitÃ©s supplÃ©mentaires :
- gestion du multi-store ;
- gestion des stocks multi-sources ;
- gestion des retours ;
- gestion avancÃ©e des permissions ;
- â€¦

## REX ğŸ¦–

Le projet que nous avons rÃ©alisÃ© peut se dÃ©composer en deux grandes parties : une partie CMS et une partie e-commerce.
Comme vous avez pu le comprendre, la partie CMS a dÃ» Ãªtre dÃ©veloppÃ©e en totalitÃ©, alors que nous nous reposons grandement sur Sylius pour la seconde.
La marque Ã©tant connue dans le monde entier, le site doit Ãªtre disponible en cinq langues et offrir plusieurs canaux de vente.

### Parlons (trÃ¨s) rapidement du CMSâ€¦ ğŸ“

Ã‰tant au final un "simple" projet Symfony, nous avons pu utiliser nos outils habituels : [docker-starter](https://github.com/jolicode/docker-starter) pour la stack de dÃ©veloppement et les commandes fabric - ainsi que [pomdokğŸ](https://github.com/jolicode/pomdok/) pour permettre aux dÃ©veloppeurs sur Mac d'avoir une stack rapide.

Nous avons fait le choix de ne pas utiliser le front fourni par Sylius, qui utilise Gulp.
Ainsi, nous avons Ã©tÃ© ici aussi maÃ®tres de nos outils : [Webpack Encore](https://symfony.com/doc/current/frontend.html) avec [atomic-builder](https://github.com/jonathanlevaillant/atomic-builder) !

Et c'est parti pour le dÃ©veloppement du projet !
AprÃ¨s avoir essayÃ© rapidement le plugin [CMS de BitBag](https://github.com/BitBagCommerce/SyliusCmsPlugin), ses limitations nous ont poussÃ© Ã  le mettre de cÃ´tÃ© pour crÃ©er notre propre CMS permettant la crÃ©ation de page sur n canaux de vente et en m langues. Pour cela, nous avons dÃ» nous intÃ©resser de prÃ¨s aux bundles Resources, Admin et Grid.
Je n'en dirai pas plus ici, car nous ne sommes pas les seuls Ã  avoir grandement apprÃ©ciÃ© les utiliser et une prÃ©sentation dÃ©taillÃ©e sera faite sur ce calendrier de l'avent AFSY. ğŸ’›


### Parlons (un peu plus) du e-commerce ğŸ›’

Ã‰videmment, ce n'est qu'une fois le catalogue rempli, les pages produits crÃ©Ã©es,â€¦ que le client nous fournit la liste complÃ¨te des canaux de vente contenant pas moins de 55 Ã©lÃ©ments.

Nous avons alors constatÃ© des soucis d'ergonomie dans l'interface d'administration.
Par exemple, lors d'une crÃ©ation de page, nous nous retrouvons avec 55 checkboxes Ã  cocher pour activer la page dans tous les pays :

![SÃ©lecteur des canaux de vente]({{ asset('build/avent/2019/16/channels.png') }} "SÃ©lecteur des canaux de vente")

Pour pallier rapidement Ã  ce souci, nous avons tout simplement ajoutÃ© 2 Ã©lÃ©ments avec un peu de JS pour nous permettre de cocher ou dÃ©cocher la totalitÃ© des canaux en un clic.

Temps de dÃ©veloppement : 5 min, temps et confort gagnÃ©s par le client : non nÃ©gligeable.

![SÃ©lecteur++ des canaux de vente]({{ asset('build/avent/2019/16/channels-2.png') }} "SÃ©lecteur++ des canaux de vente")

DeuxiÃ¨me souci qui est apparu : le client doit remplir le prix de chaque produit pour chaque nouveau canal de vente.
Rapide calcul : pour un catalogue d'environ 150 produits sur 55 canaux, il faut donc complÃ©ter 8 250 prix. Avec certains produits proposant des options de configuration (taille / couleurs / â€¦), on arrive en rÃ©alitÃ© Ã  un total mirobolant de 55 000 prix Ã  insÃ©rer.
C'est Ã©videmment impossible.
Notre mÃ©thode : comme il n'existe que 3 devises et que les prix sont trÃ¨s souvent les mÃªmes selon les pays, nous avons donc commencÃ© par ajouter 3 champs au formulaire d'Ã©dition de produit : prix en EUR, prix en USD et prix en GBP, Ã  l'aide d'une extension du FormType `ProductType`.
Ceci nous permet de simplifier la mise Ã  jour des prix du produit, pour chaque canal disponible.

Temps de dÃ©veloppement : 1H, gain de temps pour le client : Ã©norme.

Depuis, nous avons ajoutÃ© une fonctionnalitÃ© dâ€™import de catalogue nous Ã©vitant de devoir toucher Ã  tout cela :)

Les dÃ©veloppeurs de Sylius savent que l'administration devient rapidement impraticable quand la boutique possÃ¨de trop de canaux et qu'ils ont un vrai travail Ã  faire sur ce point.

Nous nous sommes par la suite concentrÃ© sur la partie e-commerce. Ã‰videmment, les Ã©tapes du tunnel de commande souhaitÃ©es par le client ne sont pas les mÃªmes que [celles proposÃ©es par Sylius](https://docs.sylius.com/en/1.6/book/orders/checkout.html) : il faut supprimer des Ã©tapes, en ajouter et en rÃ©ordonner, crÃ©er de nouveaux champs dans des formulaires, en enlever d'autres, â€¦

GrÃ¢ce Ã  l'utilisation de `winzou/state-machine`, pas de souci pour customiser notre tunnel de commande :

![Checkout State Machine]({{ asset('build/avent/2019/16/sylius_order_checkout.png') }} "Checkout State Machine")

Avant de sortir du panier, et pour entrer dans le tunnel, nous souhaitons proposer Ã  lâ€™utilisateur de se connecter ou de continuer en simple visiteur. Pour cela, nous avons donc ajoutÃ© une Ã©tape `sign_in` venant de `cart` et permettant d'Ãªtre `signed_in`. Pour gÃ©rer cette nouvelle Ã©tape, nous ajoutons un couple route / action qui sera responsable dâ€™afficher le page Ã  lâ€™utilisateur, de traiter sa demande puis dâ€™appliquer la transition de la machine Ã  Ã©tat.

Dans notre contexte, il est obligatoire de sÃ©lectionner un mode de livraison et de paiement, les Ã©tapes `skip_shipping` et `skip_payment` ne sont donc pas nÃ©cessaires, et peuvent Ãªtre supprimÃ©es.

Nous souhaitons Ã©galement sÃ©lectionner le mode de livraison avant de saisir les adresses de livraison et de facturation. Pour cela, nous Ã©changeons les Ã©tapes `address` et `select_shipping`.

![Checkout State Machine Fixed !]({{ asset('build/avent/2019/16/sylius_order_checkout-fixed.png') }} "Checkout State Machine Fixed !")
_RÃ©alisÃ© avec Paint ğŸ‘Œ_

Et voila ! Notre tunnel de commande est dÃ©jÃ  terminÃ© !

Le ressenti final de l'Ã©quipe est plutÃ´t trÃ¨s positif concernant Sylius, qui n'a Ã©tÃ© en aucun cas un frein durant le dÃ©veloppement du CMS, et mÃªme un accÃ©lÃ©rateur considÃ©rable sur la partie e-commerce. La documentation n'est pas parfaite, mais reste tout de mÃªme trÃ¨s correcte.

Point bonus : Il est facile d'obtenir de l'aide via le [Slack Sylius](https://sylius-slackin.herokuapp.com/) oÃ¹ se retrouvent environ 2 500 personnes sur #general, et 150 sur #french.

## Et aprÃ¨s ?

Une version 1.7 est en prÃ©paration pour FÃ©vrier 2020.
Notre projet a commencÃ© sur la 1.5, et sa migration vers la version 1.6 a Ã©tÃ© totalement transparente. Nous verrons si la migration vers 1.7 se passe aussi simplement que pour la 1.6 :)
Ã€ lâ€™instar des versions de Symfony, il y aura une version 1.8 permettant un passage en douceur vers une 2.0.

## Vers lâ€™infini et au-delÃ â€¦ de 2019 :)

Depuis quelques semaines, Sylius a mis plus en avant sa [roadmap](https://sylius.com/roadmap). On peut y voir un net effort rÃ©parti sur plusieurs axes distincts :
- documentation : checklist pour production, guide de migrations, â€¦ ;
- fonctionnalitÃ©s : ajout d'un Store Locator, amÃ©lioration des emails transactionnels, â€¦ ;
- la mise Ã  jour des briques techniques : passage Ã  Webpack, compatibilitÃ© Symfony 5, â€¦

Certains chantiers pourraient Ãªtre trÃ¨s intÃ©ressants et sâ€™annoncent trÃ¨s prometteur pour lâ€™avenir : un passage Ã  Symfony Workflow, un autre vers API Platform, â€¦
Affaire Ã  suivre !

Excellentes fÃªtes de fin dâ€™annÃ©e.

{% endblock %}

{% block article_avatar %}
    <img src="{{ asset('build/avent/benjamin-clay.jpg') }}" alt="Benjamin Clay"/>
{% endblock %}

{% block article_bio %}
   <h2><a href="{% block author_url 'https://twitter.com/ternel/' %}">{% block article_author 'Benjamin Clay' %}</a></h2>
   <p>Benjamin est expert Web chez <a href="https://jolicode.com" target="_blank" rel="noopener noreferrer">JoliCode</a>.</p>
{% endblock %}
