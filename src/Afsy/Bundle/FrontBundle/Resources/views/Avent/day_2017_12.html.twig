{% extends 'AfsyFrontBundle:Avent:day.html.twig' %}

{% set year = 2017 %}

{% block article_title "Jour 12 - Serverless, PHP et Symfony" %}

{% block article_content %}
    <style type="text/css">
        em {
            font-family: sans-serif;
        }
    </style>
    <h1 id="serverless-php-et-symfony">Serverless, PHP et Symfony</h1>

    <p>
        Depuis une dizaine dâ€™annÃ©es, le monde du dÃ©ploiement et de lâ€™hÃ©bergement
        dâ€™applications web change Ã  une vitesse phÃ©nomÃ©nale. Lâ€™arrivÃ©e de
        <abbr title="Amazon Web Services" lang="en">AWS</abbr> et
        de leurs <abbr title="Virtual Machine" lang="en">VM</abbr>s en deux
        clics, puis lâ€™arrivÃ©e de <abbr title="Platform as a Service" lang="en">PaaS</abbr>
        comme Heroku (d'ailleurs, consultez
        <a href="https://afsy.fr/avent/2017/03-deployer-un-projet-symfony-flex-sur-heroku">l'article d'Alex sur Symfony &amp; Heroku</a>
        si vous ne l'avez pas encore lu !), puis lâ€™arrivÃ©e des conteneurs
        (ou <em lang="en">containers</em>). Dans le viseur aujourdâ€™hui, ce sont
        les <abbr title="Functions as a Service" lang="en">Faas</abbr> ou
        Â« <span lang="en">serverless</span> Â».
    </p>

    <p>
        Aujourdâ€™hui, nous Ã©tudierons en quoi ces nouvelles offres
        Â« <span lang="en">serverless</span> Â» ont un intÃ©rÃªt pour nous,
        utilisateurs et crÃ©ateurs dâ€™applications web. Nous verrons Ã©galement
        comment utiliser ces offres pour votre application Symfony.
    </p>

    <h2 id="quest-ce-que-serverless">Quâ€™est-ce que serverless</h2>

    <p>
        Dâ€™aprÃ¨s le nom, en francais Â« sans-serveur Â», on peut comprendre lâ€™idÃ©e :
        il nâ€™y a pas de serveur Ã  gÃ©rer. Cela veut dire pas de machine dÃ©diÃ©e
        chez OVH, pas de EC2 chez AWS ou encore pas de dyno chez Heroku.
    </p>

    <p>
        Câ€™est tout simplement un PaaS donc ? Ou bien un hÃ©bergement mutualisÃ© Ã 
        lâ€™ancienne ? Eh bienâ€¦ non plus. On peut rÃ©sumer les Â« FaaS Â» par les
        points suivants :
    </p>

    <ol>
        <li>
            <span lang="en"></span><strong>Pay-as-you <em>really</em> go</strong></span>.
            Toutes les autres alternatives, Ã  ma connaissance, facturent un
            prix de base par mois, qui inclut une certaine quantitÃ© de
            trafic et/ou de ressources utilisables. Pour ces offres lÃ , vous
            ne payez quâ€™au nombre dâ€™exÃ©cutions.
            <br/>
            Câ€™est-Ã -dire : 0 requÃªtes = 0 â‚¬.
        </li>
        <li>
            <strong lang="en">Stateless</strong>.
            Chaque exÃ©cution de notre fonction est indÃ©pendante. Typiquement,
            on ne pourra pas Ã©crire sur le disque dur pour la prochaine
            requÃªte. Il faut aussi imaginer que notre fonction sera exÃ©cutÃ©e
            quelque part, mais nous nâ€™avons aucun contrÃ´le sur lâ€™endroit.
        </li>
        <li>
            <strong lang="en">Scalable</strong>. Il nâ€™y a plus de serveur (Ã  votre
            connaissance). Ces fonctions sont des processus <em lang="en">stateless</em>
            exÃ©cutÃ©s pour quelques  millisecondes, voire quelques secondes. Ces
            contraintes leur permettent dâ€™Ãªtre exÃ©cutÃ©es sur une quantitÃ© trÃ¨s
            importante de machines, en parallÃ¨le, et donc de rÃ©pondre Ã  des pics
            de demande extrÃªmement importants.
        </li>
    </ol>

    <p>
        Cela nous donne une solution qui ne coÃ»te rien lorsqu'elle n'est pas
        utilisÃ©e, mais qui permet une mise Ã  l'Ã©chelle (ou de rÃ©pondre Ã  de gros
        pics de trafic) en quelques secondes. Un bon exemple pour prouver
        lâ€™intÃ©rÃªt de telles infrastructures est <a href="http://www.bbc.co.uk/blogs/internet/entries/683c2e2a-c1ee-490b-9a97-23214505aba4">la BBC</a> :
        ils utilisent <a href="https://aws.amazon.com/fr/lambda/details/">AWS Lambda</a>
        pour faire du rendu de <span lang="en">frames</span> vidÃ©os en temps
        rÃ©el. Lorsqu'aucun rendu nâ€™est Ã  effectuer, cela ne leur coute rien,
        mais ils peuvent absorber une grande quantitÃ© dâ€™exÃ©cutions, sans rien
        changer Ã  leur infrastructure.
    </p>

    <h2 id="qui-sont-les-principaux-acteurs-dans-ce-domaine">Qui sont les principaux acteurs dans ce domaine ?</h2>

    <p>
        Vous lâ€™aurez sans doute compris, Amazon Web Services a un FaaS nommÃ©
        <a href="http://docs.aws.amazon.com/lambda/latest/dg/welcome.html">"AWS Lambaâ€</a>,
        Google Cloud a les <a href="https://cloud.google.com/functions/">"Google Cloud Functionsâ€</a>,
        Azureâ€¦ <a href="https://azure.microsoft.com/en-gb/services/functions/">"Functionsâ€</a>.
        Ces trois offres sont complÃ¨tes et extrÃªmement bien intÃ©grÃ©es aux
        diffÃ©rentes plateformes, mais elles sont aussi propriÃ©taires. Puisque
        nous parlons de Symfony, il me semble important de souligner les
        alternatives Open-Source, que sont :
    </p>

    <ol>
        <li>
            <a href="https://openwhisk.apache.org">OpenWhisk</a>, un projet de
            la fondation Apache. Il est important de noter que OpenWhisk est
            disponible en version gÃ©rÃ©e par <abbr title="International Business Machines Corporation" lang="en">IBM</abbr>.
            Ce sont les <a href="https://console.bluemix.net/openwhisk/">IBM Cloud Functions</a>.
        </li>
        <li>
            <a href="https://github.com/openfaas/faas">OpenFaaS</a> et
            <a href="https://github.com/fission/fission">Fission</a> sont tous
            les deux basÃ©s sur lâ€™utilisation de conteneurs Docker. Il vous
            Â« suffit Â» dâ€™un <a href="https://kubernetes.io/">cluster Kubernetes</a>
            pour faire tourner ces deux plateformes.
        </li>
    </ol>

    <h2 id="php-dans-tout-Ã§a">PHP dans tout Ã§a ?</h2>

    <p>
        Mises Ã  part les alternatives Open-Source, PHP nâ€™est pas vraiment lâ€™ami
        des trois gros Â« <em lang="en">clouds</em> Â». Node.js et Go sont les
        grands gagnants, PHP nâ€™est mÃªme pas officiellement supportÃ© par lâ€™un
        dâ€™entre eux. La seule faÃ§on de lancer du PHP dans ces nuages consiste Ã 
        utiliser Â« <em lang="en">shim</em>.
        <a href="https://aws.amazon.com/blogs/compute/scripting-languages-for-aws-lambda-running-php-ruby-and-go/">On package le binaire de PHP dans la fonction, et on demande Ã  un petit script Node de lancer le PHP</a>
        (je vous assure, câ€™est mÃªme dans leurs documentations officielles !).
    </p>

    <p>
        <em>
            Pourtantâ€¦ PHP est fait pour Ã§a ! PHP est fait pour lancer des scripts
            trÃ¨s courts. Alors que de lâ€™autre cÃ´tÃ© de la barriÃ¨re, Node et Go ont
            Ã©tÃ© conÃ§us pour les scripts longs. Je nâ€™ai pas la rÃ©ponse au Â« pourquoi Â»
            mais je trouve Ã§a trÃ¨s Ã©tonnant.
        </em>
    </p>

    <h2 id="deployer-notre-application-symfony">Deployer notre application Symfony</h2>

    <p>
        Nous crÃ©erons et dÃ©ployerons notre application Symfony 4 dans une
        fonction OpenWhisk. Nous utilisons cette plateforme pour 3 raisons :
    </p>

    <ul>
        <li>Câ€™est une plateforme de FaaS Open-Source,</li>
        <li>Elle supporte nativement PHP,</li>
        <li>Elle dispose dâ€™une version pilotÃ©e sur le Cloud dâ€™IBM.</li>
    </ul>

    <p>
        Je vous encourage vivement Ã  l'essayer par vous mÃªme avec IBM Cloud Functions.
        Câ€™est en effet gratuit pour les premiers 400,000 GB-seconds, ce qui est
        bien plus quâ€™il n'en faut pour votre Â« <em lang="en">side project</em> Â» !.
    </p>

    <ol>
        <li>
            <strong>Configurer <code class="language-none">wsk</code>, le client OpenWhisk</strong>
            <p>
                Si vous suivez mon conseil, crÃ©ez votre compte IBM Cloud et suivez
                <a href="https://console.bluemix.net/openwhisk/learn/cli">la documentation pour configurer "wskâ€</a>.
                Sinon, configurez "wskâ€ par vous meme :)
            </p>
        </li>
        <li>
            <strong>CrÃ©er une application Symfony</strong>
            <p>
                Vous avez probablement lu <a href="https://afsy.fr/avent/2017/02-la-nouvelle-configuration-par-defaut-de-symfony4">le post de Nicolas</a>,
                et savez donc que lâ€™on dÃ©marre une application Symfony 4 avec
                <code class="language-none">composer</code> :
            </p>
            <pre><code class="language-none">$ composer create-project symfony/skeleton my-app &amp;&amp; cd my-app</code></pre>
        </li>
        <li>
            <strong>Installer le Â« <span lang="en">bridge</span> OpenWhisk</strong>
            <pre><code class="language-none">$ composer req sroze/openwhisk-bundle</code></pre>
        </li>
        <li>
            <strong>PrÃ©parer lâ€™archive de l'application</strong>
            <pre><code class="language-none">$ zip -X -r ../my-app.zip * .env*</code></pre>
        </li>
        <li>
            <strong>CrÃ©er ou mettre Ã  jour la fonction</strong>
            <pre><code class="language-none">$ wsk action update skeleton-symfony --kind php:7.1 skeleton-symfony.zip --web true</code></pre>
        </li>
        <li>
            <strong>RÃ©cupÃ©rer lâ€™<abbr title="Uniform Resource Location" lang="en">URL</abbr> de la fonction</strong>
            <pre><code class="language-none">$ wsk action get skeleton-symfony --url&lt;/td&gt;</code></pre>
            <p>Ouvrez la fonction et vous devriez avoir lâ€™application !</p>
        </li>
    </ol>


    <h2 id="que-cest-il-passÃ©">Que sâ€™est-il passÃ© ?</h2>

    <p>
        Ces quelques Ã©tapes trÃ¨s simples pour dÃ©ployer votre application Symfony
        peuvent Ãªtre troublantes. DÃ©taillons ce quâ€™il sâ€™est passÃ©.
    </p>

    <ol>
        <li>
            Vous avez configurÃ© votre environnement local afin de parler au
            serveur OpenWhisk. Rien de magique lÃ  dedans.
        </li>
        <li>
            Vous avez crÃ©Ã© une application Symfony. Câ€™est trÃ¨s simple, câ€™est le
            tout nouveau squelette Symfony. Je vous recommande
            <a href="https://afsy.fr/avent/2017/02-la-nouvelle-configuration-par-defaut-de-symfony4">lâ€™article de Nicolas pour en savoir plus sur Symfony 4</a>.
        </li>
        <li>
            Vous avez installÃ© le pont OpenWhisk pour votre application Symfony.
            Câ€™est <a href="https://github.com/sroze/openwhisk-bundle">un paquet</a>
            et avant tout <a href="https://github.com/symfony/recipes-contrib/tree/master/sroze/openwhisk-bundle/0.2">une recette pour Symfony Flex</a>,
            le nouveau systÃ¨me de gestion de configuration de Symfony. Cette
            recette a crÃ©Ã© <a href="https://github.com/symfony/recipes-contrib/blob/master/sroze/openwhisk-bundle/0.2/index.php#L33">un nouveau contrÃ´leur frontral</a>
            (remplaÃ§ant votre <code class="language-none">public/index.php</code>)
            qui sera exÃ©cutÃ© lorsque la fonction est invoquÃ©e dans le Â« <em lang="en">cloud</em> Â».
            Ce contrÃ´leur frontral transforme la requÃªte de type
            <a href="https://console.bluemix.net/docs/openwhisk/openwhisk_webactions.html">OpenWhisk Web Action</a>
            en objet
            <a href="https://symfony.com/doc/3.3/components/http_foundation.html#request">HttpFoundation Request</a>,
            puis il rÃ©alise l'opÃ©ration inverse pour la rÃ©ponse.
        </li>
        <li>
            Puisquâ€™une application Symfony est un ensemble de fichiers, nous
            devons utiliser une application de type <em lang="en">package</em>.
            Ce type dâ€™application est tout simplement un fichier ZIP de votre
            dossier.
        </li>
        <li>
            Vous avez crÃ©Ã© la fonction dans OpenWhisk. Typiquement, le fichier ZIP
            a Ã©tÃ© tÃ©lÃ©chargÃ© quelque part et rendu accessible aux conteneurs qui
            lancent ensuite vos fichiers PHP. Vous avez Ã©galement utilisÃ© l'option
            <code class="language-none">--web</code> qui prÃ©cise Ã  OpenWhisk de
            faire en sorte que cette fonction soit accessible Â« depuis le web Â».
        </li>
        <li>
            Une fois la fonction crÃ©Ã©e, il ne vous reste plus quâ€™a rÃ©cupÃ©rer
            lâ€™URL de la fonction pour lâ€™exÃ©cuter.
        </li>
    </ol>

    <h2 id="serverless-le-framework">Â« serverless Â», le framework</h2>

    <p>
        En gÃ©nÃ©ral, vous ne dÃ©ployez pas une seule fonction mais plusieurs. Vous
        n'utiliserez pas que HTTP comme dÃ©clencheur de fonction mais aussi un
        systÃ¨me de file (<em lang="en">queue</em>), un Ã©vÃ©nement dans une base
        de donnÃ©es, etc.
    </p>

    <p>
        GÃ©rer Â« manuellement Â» tous ces cas peut s'avÃ©rer Ãªtre beaucoup de
        travail, Ã  la fois trÃ¨s rÃ©pÃ©titif et difficile Ã  maintenir. Câ€™est la
        raison pour laquelle <a href="https://serverless.com">"serverlessâ€</a>
        existe. Il s'agit d'un framework Ã©crit en Node qui simplifie la gestion
        de nos fonctions. Il fait aussi office de couche d'abstraction avec
        OpenWhisk, AWS Lamba et toutes ces plateformes.
    </p>

    <p>
        Installez <em lang="en">serverless</em> et son extension pour OpenWhisk,
        puis crÃ©ez le fichier <code class="language-none">serverless.yml</code>
        dans le dossier parent de lâ€™application <code>my-app</code> que avons
        crÃ©Ã© plus tÃ´t :
    </p>

    <pre><code class="language-yaml">service: my-project

provider:
  name: openwhisk
  runtime: php

package:
  individually: true

functions:
  first-app:
    handler: my-app/index.main
  2nd-app:
    handler: 2nd-app/index.main

plugins:
  - serverless-openwhisk</code></pre>

    <p>DÃ©ployez !</p>

    <pre><code class="language-none">$ serverless deploy</code></pre>

    <h2 id="conclusion">Conclusion</h2>

    <p>
        Jâ€™espÃ¨re que cet article vous a permis dâ€™en savoir plus Ã  propos de ces
        Â« <em lang="en">functions as a service</em> Â». Il est clair que ce
        nouveau genre dâ€™offre constitue un futur encore plus simple et moins
        coÃ»teux pour expÃ©rimenter diverses idÃ©es, tout en crÃ©ant des
        architectures dimensionnables naturellement. Les outils sont toujours
        relativement expÃ©rimentaux et rares, mais je nâ€™ai aucun doute
        quâ€™ensemble nous pouvons amÃ©liorer les outils pour Symfony !
    </p>

    <p>Happy serverlessing ğŸ˜</p>

{% endblock %}

{% block article_avatar %}
    <img src="{{ asset('bundles/afsyfront/images/avent/samuel-roze.jpeg') }}" alt="Samuel Roze" />
{% endblock %}

{% block article_bio %}
<h2><a href="{% block author_url %}https://twitter.com/samuelroze?lang=fr{% endblock %}" target="_blank">{% block article_author %}Samuel Roze{% endblock %}</a></h2>
<p>
    Samuel a crÃ©Ã© et continue de maintenir <a href="https://continuouspipe.io/">ContinuousPipe</a>,
    un outil de deployment pour les applications Â« <em>containeurisÃ©es</em> Â»,
    basÃ© sur Kubernetes. Mainteneur de ApiPlatform et contributeur Ã  de nombreux
    projects Open-Source dont Symfony, il aide de multiples startups Ã  prototyper
    et concevoir leur architecture technique pour Kamet Ventures, un incubateur
    londonnien.
</p>
{% endblock %}
